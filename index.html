<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asha ‚Äî Voice Health Assistant (Final)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--blue:#0b5cff;--green:#19a974;--muted:#69707a}
  body{font-family:'Poppins',sans-serif;background:#f4f7fb;margin:0;color:#122;}
  .wrap{max-width:900px;margin:36px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(16,24,40,.06);}
  h1{margin:0 0 12px;color:var(--blue)}
  p.lead{color:var(--muted);margin:0 0 18px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  button{background:var(--blue);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600}
  button.alt{background:#eef6ff;color:var(--blue);border:1px solid #d8e9ff}
  button.green{background:var(--green)}
  #status{margin-top:8px;font-weight:600}
  #transcript{margin-top:12px;background:#f6f9ff;border-radius:10px;padding:14px;min-height:100px;color:#0d1b2a;line-height:1.4}
  .small{font-size:13px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ü©∫ Asha ‚Äî Your Caring Health Assistant</h1>
    <p class="lead">Speak naturally. Asha will ask a few caring questions (max 4) and show nearby doctors. If you say yes to booking, she will pre-fill your booking form with your account details.</p>

    <div class="controls">
      <button id="startBtn">üé§ Talk to Asha</button>
      <button id="stopBtn" class="alt">‚èπ Stop</button>
      <button id="bandhuBtn" class="green">ü§ù Bandhu (Care Helpers)</button>
    </div>

    <div id="status">Status: Idle</div>
    <div id="transcript"><em>Transcript and captured info will appear here</em></div>
    <div class="small">Note: Works best in Chrome. Allow microphone access when prompted.</div>
  </div>

<script>
/* === FINAL ROBUST VOICE FLOW - compact and reliable ===
   - uses promise-based speak() and listenOnce()
   - 4 questions total: symptoms, wantBooking (y/n), datetime (when + time), wantPackage (y/n)
   - ALWAYS redirect to doctors.html with query params (collected data)
   - auto-fill will use dummy account details: name + phone (as requested)
*/

const SPECIALTIES = {
  "Cardiologist": ["heart","chest","chest pain","palpitation","bp","blood pressure"],
  "Gastroenterologist": ["stomach","acid","heartburn","nausea","vomit","indigestion"],
  "Dermatologist": ["skin","rash","itch","acne","eczema"],
  "Neurologist": ["headache","migraine","dizzy","seizure","numb"],
  "ENT": ["ear","nose","throat","sinus","hearing"],
  "General Physician": ["fever","cold","cough","weak","tired","body ache"]
};
const PACKAGES = {
  "Cardiologist":"Heart Checkup Package",
  "Gastroenterologist":"Digestive Wellness Plan",
  "Dermatologist":"Skin & Allergy Panel",
  "Neurologist":"Neuro Screening",
  "ENT":"ENT Care Package",
  "General Physician":"General Health Package"
};

// dummy logged-in account info (auto-filled in booking form)
const ACCOUNT = { name: "LoggedIn User", phone: "9999999999" };

// ui
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const bandhuBtn = document.getElementById('bandhuBtn');
const statusEl = document.getElementById('status');
const transcriptEl = document.getElementById('transcript');

let recog = null;
let listening = false;

// helper: speak returns a promise that resolves when speaking ends
function voicesReady() {
  return new Promise(resolve => {
    const v = speechSynthesis.getVoices();
    if (v.length) return resolve();
    speechSynthesis.onvoiceschanged = () => resolve();
    // fallback timeout
    setTimeout(resolve, 700);
  });
}
async function speak(text) {
  await voicesReady();
  return new Promise(resolve => {
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-IN";
      u.rate = 0.95;
      u.pitch = 1.15;
      // try pick softer female Indian voice if available
      const v = speechSynthesis.getVoices().find(x => /female/i.test(x.name) && /en-IN|en-GB/.test(x.lang));
      if (v) u.voice = v;
      u.onend = () => resolve();
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
      statusEl.textContent = "Asha (speaking): " + text;
    } catch (err) {
      // still resolve so flow continues
      console.warn("speak err", err);
      resolve();
    }
  });
}

// helper: listen once with timeout (returns recognized text or empty string)
function listenOnce(timeoutMs = 8000) {
  return new Promise((resolve) => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      resolve(""); // not supported
      return;
    }
    try {
      const r = new SR();
      recog = r;
      r.lang = 'en-IN';
      r.interimResults = false;
      r.maxAlternatives = 1;
      listening = true;
      statusEl.textContent = "Asha (listening)‚Ä¶";
      let done = false;
      const finish = (text) => {
        if (done) return;
        done = true;
        listening = false;
        try { r.onresult = r.onerror = r.onend = null; r.stop(); } catch {}
        resolve(text || "");
      };
      r.onresult = (ev) => {
        const t = ev.results[0][0].transcript.trim();
        appendTranscript("You: " + t);
        finish(t);
      };
      r.onerror = (e) => {
        console.warn("recognition error", e);
        finish("");
      };
      r.onend = () => {
        // if no result fired, return empty string
        if (!done) finish("");
      };
      r.start();
      // safety timeout
      setTimeout(() => finish(""), timeoutMs);
    } catch (e) {
      console.warn("listenOnce exception", e);
      resolve("");
    }
  });
}

function appendTranscript(txt) {
  // append and scroll
  if (transcriptEl.innerHTML.trim().startsWith("<em>")) transcriptEl.innerHTML = "";
  transcriptEl.innerHTML += `<div style="margin:8px 0">${txt}</div>`;
  transcriptEl.scrollTop = transcriptEl.scrollHeight;
}

function detectSpecialist(text) {
  const t = (text || "").toLowerCase();
  let best = "General Physician", score = 0;
  for (const s in SPECIALTIES) {
    let c = 0;
    for (const kw of SPECIALTIES[s]) if (t.includes(kw)) c++;
    if (c > score) { score = c; best = s; }
  }
  return best;
}
function isYes(text) {
  return /^(yes|yeah|yep|sure|please|ok|okay)\b/i.test((text||"").trim());
}

// MAIN flow: strictly 4 questions (some may be short/empty) then redirect
async function runFlow() {
  try {
    // Reset
    data = { symptoms: "", specialist: "", wantBooking: false, datetime: "", area: "", package: "", accountName: ACCOUNT.name, accountPhone: ACCOUNT.phone };
    transcriptEl.innerHTML = "";
    // Q1 - symptoms
    await speak("Hi, I am Asha. Tell me briefly what symptoms you have.");
    const q1 = await listenOnce(9000);
    appendTranscript("Asha: Thank you. I heard: " + (q1 || "[no response]"));
    data.symptoms = q1 || "";
    data.specialist = detectSpecialist(q1 || "");
    // Q2 - do you want me to book?
    await speak(`I think a ${data.specialist} can help. Would you like me to help book an appointment for you?`);
    const q2 = await listenOnce(7000);
    appendTranscript("Asha: I heard: " + (q2 || "[no response]"));
    data.wantBooking = isYes(q2);
    // Q3 - when & time combined (ask only if wantBooking or always ask? per requirement we keep max 4, and always proceed)
    await speak("When would you prefer the appointment and at what time? For example, tomorrow morning or 5th June evening.");
    const q3 = await listenOnce(9000);
    appendTranscript("Asha: I heard: " + (q3 || "[no response]"));
    data.datetime = q3 || "";
    // Try to extract area from q3 if not provided already
    // Q4 - package
    await speak("Would you like me to include a health check package as well?");
    const q4 = await listenOnce(7000);
    appendTranscript("Asha: I heard: " + (q4 || "[no response]"));
    if (isYes(q4)) {
      data.package = PACKAGES[data.specialist] || PACKAGES["General Physician"];
    } else {
      data.package = "";
    }
    // final sentence and redirect
    await speak("All right, thank you. I will show the doctors now.");
  } catch (e) {
    console.error("Flow error", e);
  } finally {
    // always redirect to doctors.html with parameters
    const q = new URLSearchParams({
      symptoms: data.symptoms || "",
      specialist: data.specialist || "",
      datetime: data.datetime || "",
      area: data.area || "",
      package: data.package || "",
      accountName: ACCOUNT.name,
      accountPhone: ACCOUNT.phone,
      wantBooking: data.wantBooking ? "true" : "false"
    }).toString();
    // small pause then redirect
    setTimeout(()=> window.location.href = "doctors.html?" + q, 500);
  }
}

// button wiring
startBtn.addEventListener('click', () => {
  if (listening) { statusEl.textContent = "Already listening‚Ä¶"; return; }
  speechSynthesis.cancel();
  runFlow();
});
stopBtn.addEventListener('click', () => {
  try { if (recog) recog.stop(); } catch {}
  speechSynthesis.cancel();
  statusEl.textContent = "Stopped.";
});
bandhuBtn.addEventListener('click', ()=> location.href = 'bandhu.html');

</script>
</body>
</html>
