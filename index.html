<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asha ‚Äî Health Voice Bot (Final)</title>
  <style>
    body {
      font-family: 'Poppins', system-ui, sans-serif;
      background: #f7f8fb;
      color: #111;
      padding: 28px;
      text-align: center;
    }
    h1 { color: #0b5cff; margin-bottom: 6px; }
    p.lead { color: #333; margin-top: 0; margin-bottom: 12px; }
    button {
      background: #0b5cff;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button.secondary {
      background: #e6eefc;
      color: #0b5cff;
      margin-left: 8px;
    }
    #status { margin-top: 14px; font-weight: 600; }
    #mic {
      width: 48px; height: 48px;
      margin: 12px auto;
      border-radius: 50%;
      display: none;
    }
    .listening { animation: pulse 1s infinite; background: #ff5b5b; }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.15); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    #transcript {
      display: none;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      margin: 14px auto;
      max-width: 680px;
      text-align: left;
      box-shadow: 0 4px 18px rgba(16,24,40,0.06);
    }
    pre.debug {
      background: #111;
      color: #fff;
      padding: 8px;
      border-radius: 6px;
      max-width: 880px;
      margin: 10px auto;
      overflow: auto;
      text-align: left;
    }
  </style>
</head>

<body>
  <h1>ü©∫ Talk to Asha</h1>
  <p class="lead">Click <strong>Talk to Asha</strong> ‚Äî microphone will open and Asha will speak back.</p>

  <div>
    <button id="startBtn">üé§ Talk to Asha</button>
    <button id="endBtn" class="secondary" style="display:none">‚èπ End Call</button>
    <button id="openFloating" class="secondary" style="display:none">Open Official Widget</button>
  </div>

  <div id="mic" aria-hidden="true"></div>
  <div id="status">Waiting to connect‚Ä¶</div>

  <div id="transcript">
    <h3>Conversation Transcript</h3>
    <div id="transcriptBody"></div>
  </div>

  <div id="diagnostics" aria-hidden="true">
    <pre id="diagPre" class="debug" style="display:none"></pre>
  </div>

  <!-- Disable automatic floating widget -->
  <script>window.ELEVENLABS_WIDGET_DISABLE_AUTO_INIT = true;</script>

  <script>
  (function () {
    const AGENT_ID = "agent_1901k8v4exkseqk9s4ts0a5ycks2";

    const SDK_URLS = [
      "https://elevenlabs.io/convai-widget/index.js",
      "https://cdn.elevenlabs.io/convai-widget/index.js",
      "https://cdn.elevenlabs.io/convai-widget/v1/convai-widget.js"
    ];

    const startBtn = document.getElementById("startBtn");
    const endBtn = document.getElementById("endBtn");
    const openFloating = document.getElementById("openFloating");
    const status = document.getElementById("status");
    const mic = document.getElementById("mic");
    const transcript = document.getElementById("transcript");
    const transcriptBody = document.getElementById("transcriptBody");
    const diagPre = document.getElementById("diagPre");

    let conversationWidget = null;
    let sdkLoaded = false;
    let lastLog = "";

    function log(...args) {
      const line = `[${new Date().toLocaleTimeString()}] ${args.join(" ")}`;
      console.log(line);
      lastLog += line + "\n";
      diagPre.style.display = "block";
      diagPre.textContent = lastLog;
    }

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = url;
        s.onload = () => resolve(url);
        s.onerror = () => reject(url);
        document.head.appendChild(s);
      });
    }

    async function tryLoadSDK() {
      for (const url of SDK_URLS) {
        try {
          log("Trying loader:", url);
          await loadScript(url);
          await new Promise(r => setTimeout(r, 300));
          if (window.elevenlabs && typeof window.elevenlabs.Conversation === "function") {
            log("‚úÖ SDK loaded from:", url);
            sdkLoaded = true;
            return true;
          }
        } catch (e) {
          log("‚ùå Failed loader:", url);
        }
      }
      log("All loader URLs failed.");
      return false;
    }

    function waitForSDK() {
      return new Promise((resolve, reject) => {
        let tries = 0;
        const iv = setInterval(() => {
          tries++;
          if (window.elevenlabs && typeof window.elevenlabs.Conversation === "function") {
            clearInterval(iv);
            resolve();
          }
          if (tries > 50) {
            clearInterval(iv);
            reject("SDK not ready");
          }
        }, 100);
      });
    }

    async function startConversation() {
      status.textContent = "Loading ElevenLabs SDK...";
      if (!sdkLoaded) {
        const ok = await tryLoadSDK();
        if (!ok) {
          status.textContent = "‚ùå ElevenLabs failed to load. Check diagnostics.";
          openFloating.style.display = "inline-block";
          return;
        }
      }

      try {
        await waitForSDK();
      } catch {
        status.textContent = "‚ùå SDK not ready.";
        return;
      }

      if (!window.elevenlabs) {
        status.textContent = "‚ùå ElevenLabs global not found.";
        return;
      }

      status.textContent = "Connecting to Asha‚Ä¶";
      try {
        conversationWidget = window.elevenlabs.Conversation({
          agentId: AGENT_ID,
          onConnect: () => {
            log("Connected!");
            status.textContent = "üé§ Listening‚Ä¶ Speak now!";
            mic.style.display = "block";
            mic.classList.add("listening");
            endBtn.style.display = "inline-block";
            startBtn.style.display = "none";
            transcript.style.display = "block";
          },
          onMessage: (msg) => {
            const who = msg.source === "user" ? "You" : "Asha";
            const text = msg.message || msg.text || "";
            const p = document.createElement("p");
            p.innerHTML = `<strong>${who}:</strong> ${text}`;
            transcriptBody.appendChild(p);
          },
          onDisconnect: () => {
            handleEnd();
          }
        });
        await conversationWidget.startSession();
      } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Could not connect. Check Agent ID or allowlist.";
        openFloating.style.display = "inline-block";
      }
    }

    function handleEnd() {
      status.textContent = "Call ended.";
      mic.classList.remove("listening");
      endBtn.style.display = "none";
      startBtn.style.display = "inline-block";
    }

    startBtn.addEventListener("click", startConversation);
    endBtn.addEventListener("click", () => {
      if (conversationWidget && conversationWidget.stopSession) conversationWidget.stopSession();
      handleEnd();
    });

    openFloating.addEventListener("click", () => {
      const html = `
        <!doctype html>
        <meta charset="utf-8">
        <title>Asha - floating</title>
        <elevenlabs-convai agent-id="${AGENT_ID}"></elevenlabs-convai>
        <script src="https://elevenlabs.io/convai-widget/index.js"><\/script>`;
      const w = window.open();
      if (w) {
        w.document.open();
        w.document.write(html);
        w.document.close();
      } else {
        alert("Please allow popups for this site.");
      }
    });

    log("Page loaded. Click Talk to Asha to begin.");
  })();
  </script>
</body>
</html>
