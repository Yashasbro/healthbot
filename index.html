<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asha - Medical Assistant</title>

  <!-- ElevenLabs Widget -->
  <script src="https://elevenlabs.io/convai-widget/index.js" async></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f9f9fb;
      color: #333;
      text-align: center;
      padding: 2rem;
    }
    h1 {
      color: #007bff;
      margin-bottom: 1rem;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.8rem 1.6rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #statusText {
      margin-top: 1rem;
      font-weight: 600;
    }
    #micAnimation.listening {
      width: 50px; height: 50px;
      border-radius: 50%;
      background: #ff4747;
      margin: 1rem auto;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }
    #transcriptBox {
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem auto;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      text-align: left;
      display: none;
    }
    .hidden { display: none; }
  </style>
</head>

<body>
  <h1>ü©∫ Talk to Asha</h1>
  <p>Hi! I‚Äôm Asha, your friendly health assistant. Click below to start talking!</p>

  <button id="startBtn">üé§ Talk to Asha</button>
  <button id="endCallBtn" class="hidden">‚èπ End Call</button>

  <div id="micAnimation" class="hidden"></div>
  <div id="statusText">Waiting to connect...</div>

  <div id="transcriptBox">
    <h3>Conversation Transcript:</h3>
    <div id="transcriptText"></div>
  </div>

  <script>
    // üëá Replace this with your actual ElevenLabs Agent ID
    const ELEVENLABS_AGENT_ID = "agent_1901k8v4exkseqk9s4ts0a5ycks2";

    let conversationWidget = null;
    let conversationTranscript = "";

    // Start button logic
    document.getElementById('startBtn').addEventListener('click', () => {
      initElevenLabsConversation();
    });

    // End button logic
    document.getElementById('endCallBtn').addEventListener('click', () => {
      if (conversationWidget) {
        conversationWidget.stopSession();
      }
      handleConversationEnd();
    });

    // Function to handle call end
    function handleConversationEnd() {
      document.getElementById('statusText').textContent = 'Call ended.';
      document.getElementById('micAnimation').classList.remove('listening');
      document.getElementById('endCallBtn').classList.add('hidden');
    }

    // --------------------------------------------
    // ELEVENLABS INTEGRATION STARTS HERE
    // --------------------------------------------
    async function initElevenLabsConversation() {
      const statusText = document.getElementById('statusText');
      const micAnimation = document.getElementById('micAnimation');
      const transcriptBox = document.getElementById('transcriptBox');
      const transcriptText = document.getElementById('transcriptText');
      const endCallBtn = document.getElementById('endCallBtn');

      statusText.textContent = "Connecting to Asha...";

      // Ensure library loaded
      if (!window.elevenlabs || typeof window.elevenlabs.Conversation !== 'function') {
        statusText.textContent = "Loading ElevenLabs SDK...";
        await new Promise(res => setTimeout(res, 1500));
      }

      try {
        // Initialize conversation widget
        conversationWidget = window.elevenlabs.Conversation({
          agentId: ELEVENLABS_AGENT_ID,

          onConnect: () => {
            console.log("Connected to Asha ‚úÖ");
            statusText.textContent = "üé§ Listening... Speak now!";
            micAnimation.classList.remove('hidden');
            micAnimation.classList.add('listening');
            endCallBtn.classList.remove('hidden');
            transcriptBox.style.display = "block";
          },

          onMessage: (msg) => {
            // Both your voice and Asha's responses show here
            const who = msg.source === 'user' ? 'You' : 'Asha';
            const text = msg.message || msg.text || '';
            const line = `<p><strong>${who}:</strong> ${text}</p>`;
            transcriptText.innerHTML += line;
            conversationTranscript += text + " ";
          },

          onDisconnect: () => {
            console.log("Asha disconnected ‚ùå");
            handleConversationEnd();
          }
        });

        // Start session (prompts mic access)
        await conversationWidget.startSession();
      } catch (err) {
        console.error("Error connecting:", err);
        statusText.textContent = "‚ùå Could not connect. Check Agent ID or domain allowlist.";
      }
    }
  </script>
</body>
</html>
