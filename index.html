<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asha ‚Äî Health Voice Bot (Final)</title>
<style>
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Poppins",sans-serif;background:#f7f8fb;color:#111;padding:28px;text-align:center}
  h1{color:#0b5cff;margin-bottom:6px}
  p.lead{color:#333;margin-top:0;margin-bottom:12px}
  button{background:#0b5cff;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600}
  button.secondary{background:#e6eefc;color:#0b5cff;margin-left:8px}
  #status{margin-top:14px;font-weight:600}
  #mic{width:48px;height:48px;margin:12px auto;border-radius:50%;display:none}
  .listening{animation:pulse 1s infinite;background:#ff5b5b}
  @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.15);opacity:0.7}100%{transform:scale(1);opacity:1}}
  #transcript{display:none;background:#fff;padding:12px;border-radius:10px;margin:14px auto;max-width:680px;text-align:left;box-shadow:0 4px 18px rgba(16,24,40,0.06)}
  pre.debug{background:#111;color:#fff;padding:8px;border-radius:6px;max-width:880px;margin:10px auto;overflow:auto;text-align:left}
  a.fallback{display:inline-block;margin-top:12px;color:#0b5cff}
</style>
</head>
<body>
  <h1>ü©∫ Talk to Asha</h1>
  <p class="lead">Click <strong>Talk to Asha</strong> ‚Äî microphone will open and Asha will speak back.</p>

  <div>
    <button id="startBtn">üé§ Talk to Asha</button>
    <button id="endBtn" class="secondary" style="display:none">‚èπ End Call</button>
    <button id="openFloating" class="secondary" style="display:none">Open Official Widget</button>
  </div>

  <div id="mic" aria-hidden="true"></div>
  <div id="status">Waiting to connect‚Ä¶</div>

  <div id="transcript">
    <h3>Conversation Transcript</h3>
    <div id="transcriptBody"></div>
  </div>

  <div id="diagnostics" aria-hidden="true">
    <pre id="diagPre" class="debug" style="display:none"></pre>
  </div>

  <!--  DISABLE automatic floating widget (must be before loader) -->
  <script>window.ELEVENLABS_WIDGET_DISABLE_AUTO_INIT = true;</script>

  <!-- The loader will try several known paths (works around CDN/DNS issues) -->
  <script>
  (function(){
    // YOUR agent id
    const AGENT_ID = "agent_1901k8v4exkseqk9s4ts0a5ycks2";

    // Known possible loader URLs (tried sequentially)
    const SDK_URLS = [
      "https://elevenlabs.io/convai-widget/index.js",           // primary public path
      "https://cdn.elevenlabs.io/convai-widget/index.js",      // sometimes used
      "https://cdn.elevenlabs.io/convai-widget/v1/convai-widget.js" // fallback
    ];

    // UI refs
    const startBtn = document.getElementById("startBtn");
    const endBtn = document.getElementById("endBtn");
    const openFloating = document.getElementById("openFloating");
    const status = document.getElementById("status");
    const mic = document.getElementById("mic");
    const transcript = document.getElementById("transcript");
    const transcriptBody = document.getElementById("transcriptBody");
    const diagPre = document.getElementById("diagPre");

    let conversationWidget = null;
    let sdkLoaded = false;
    let lastLoaderError = null;

    // Append logs to diagnostics
    function diagLog(...args){
      const t = new Date().toISOString();
      lastLoaderError = (lastLoaderError || "") + "\n" + t + " | " + args.map(String).join(" ");
      diagPre.style.display = "block";
      diagPre.textContent = lastLoaderError;
      console.debug(...args);
    }

    // Dynamically load script, returns promise resolved on load or rejected on error
    function loadScript(url, timeoutMs = 7000){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = url;
        s.async = true;
        let done = false;
        const to = setTimeout(() => {
          if (done) return;
          done = true;
          s.onerror = s.onload = null;
          s.remove();
          reject(new Error("timeout"));
        }, timeoutMs);
        s.onload = () => {
          if (done) return;
          done = true;
          clearTimeout(to);
          resolve(url);
        };
        s.onerror = (ev) => {
          if (done) return;
          done = true;
          clearTimeout(to);
          s.remove();
          reject(new Error("load_error"));
        };
        document.head.appendChild(s);
      });
    }

    // Try loaders sequentially
    async function tryLoadSDK(){
      diagLog("Attempting to load ElevenLabs SDK from known URLs...");
      for (const url of SDK_URLS){
        diagLog("Trying:", url);
        try{
          await loadScript(url, 8000);
          // small wait to allow script to register custom elements
          await new Promise(r => setTimeout(r, 200));
          if (window.elevenlabs && typeof window.elevenlabs.Conversation === "function"){
            sdkLoaded = true;
            diagLog("SDK loaded OK from", url);
            return true;
          } else {
            diagLog("Script loaded but `window.elevenlabs.Conversation` not available yet from", url);
            // continue trying other URLs
          }
        }catch(err){
          diagLog("Failed to load from", url, "error:", err.message || err);
          // try next
        }
      }
      diagLog("All loader attempts failed.");
      return false;
    }

    // Wait helper for sdk to be ready (poll window)
    function waitForSDKReady(maxMs = 5000){
      return new Promise((resolve,reject) => {
        const start = Date.now();
        const iv = setInterval(() => {
          if (window.elevenlabs && typeof window.elevenlabs.Conversation === "function"){
            clearInterval(iv);
            resolve(true);
            return;
          }
          if (Date.now() - start > maxMs){
            clearInterval(iv);
            reject(new Error("sdk_ready_timeout"));
          }
        }, 120);
      });
    }

    // Start conversation (our custom UI)
    async function startConversation(){
      status.textContent = "Preparing...";
      diagLog("startConversation invoked");
      // if SDK not loaded yet try to load it
      if (!sdkLoaded){
        status.textContent = "Loading ElevenLabs SDK (attempts) ...";
        const ok = await tryLoadSDK();
        if (!ok){
          status.textContent = "‚ùå ElevenLabs failed to load. See diagnostics below.";
          diagLog("SDK not loaded after attempts - give up for now.");
          // Show fallback control: open official widget in a new tab (user can try)
          openFloating.style.display = "inline-block";
          return;
        }
        try{
          await waitForSDKReady(4000);
        }catch(e){
          diagLog("SDK loaded but not ready:", e.message);
        }
      }

      // Now SDK should be available
      if (!window.elevenlabs || typeof window.elevenlabs.Conversation !== "function"){
        status.textContent = "‚ùå ElevenLabs SDK loaded but Conversation() not available.";
        diagLog("window.elevenlabs present but Conversation missing:", window.elevenlabs);
        openFloating.style.display = "inline-block";
        return;
      }

      // If a previous widget exists, stop it
      try{ if (conversationWidget && typeof conversationWidget.stopSession === "function") conversationWidget.stopSession(); }catch(e){}

      // Create a new conversation instance
      try{
        conversationWidget = window.elevenlabs.Conversation({
          agentId: AGENT_ID,
          onConnect: () => {
            status.textContent = "üé§ Connected ‚Äî listening. Speak now!";
            mic.style.display = "block"; mic.classList.add("listening");
            endBtn.style.display = "inline-block";
            startBtn.style.display = "none";
            transcript.style.display = "block";
            diagLog("onConnect fired");
          },
          onMessage: (message) => {
            try{
              const who = (message && message.source === "user") ? "You" : "Asha";
              const text = message && (message.message || message.text || "");
              const p = document.createElement("p");
              p.innerHTML = `<strong>${who}:</strong> ${escapeHtml(String(text))}`;
              transcriptBody.appendChild(p);
              transcriptBody.scrollTop = transcriptBody.scrollHeight;
            }catch(e){
              diagLog("onMessage error:", e.message);
            }
          },
          onDisconnect: () => {
            diagLog("onDisconnect fired");
            handleEnd();
          }
        });

        status.textContent = "üîÅ Starting audio session (browser will ask for mic permission)‚Ä¶";
        await conversationWidget.startSession();
        diagLog("startSession() returned/pending");
      }catch(err){
        diagLog("Failed to start conversationWidget:", err && err.message ? err.message : err);
        status.textContent = "‚ùå Could not start session. Check agent ID, allowlist, or console for details.";
        openFloating.style.display = "inline-block";
      }
    }

    function handleEnd(){
      status.textContent = "Call ended.";
      mic.classList.remove("listening");
      endBtn.style.display = "none";
      startBtn.style.display = "inline-block";
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    // Button wiring
    startBtn.addEventListener("click", startConversation);
    endBtn.addEventListener("click", ()=>{ if (conversationWidget && conversationWidget.stopSession) conversationWidget.stopSession(); handleEnd(); });

    // Show official floating widget in new tab (fallback)
    openFloating.addEventListener("click", () => {
      // open a minimal page showing the official widget (so it uses official embed)
      const html = `<!doctype html><meta charset="utf-8"><title>Asha - floating</title>
      <elevenlabs-convai agent-id="${AGENT_ID}"></elevenlabs-convai>
      <script src="https://elevenlabs.io/convai-widget/index.js"></script>`;
      const w = window.open();
      if (!w) { alert("Popup blocked ‚Äî allow popups for this site to use fallback widget."); return; }
      w.document.open(); w.document.write(html); w.document.close();
    });

    // Immediately expose diagnostics button if page is used for debugging
    // (press start once and then inspect diagPre in the UI)
    diagLog("UI ready. Press 'Talk to Asha' to begin. SDK will be loaded automatically if needed.");
  })();
  </script>
</body>
</html>
