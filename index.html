<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asha - Health Voice Bot</title>
<style>
  body{font-family:'Poppins',sans-serif;background:#f9f9fb;color:#333;text-align:center;padding:2rem}
  h1{color:#007bff;margin-bottom:1rem}
  button{background:#007bff;color:white;border:none;padding:0.8rem 1.6rem;font-size:1rem;border-radius:8px;cursor:pointer;margin:0.4rem}
  button:hover{background:#0056b3}
  button.secondary{background:#e6eefc;color:#007bff}
  #statusText{margin-top:1rem;font-weight:600}
  #micAnimation.listening{width:50px;height:50px;border-radius:50%;background:#ff4747;margin:1rem auto;animation:pulse 1s infinite}
  @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:0.6}100%{transform:scale(1);opacity:1}}
  #transcriptBox{background:#fff;padding:1rem;border-radius:10px;margin:1rem auto;width:90%;max-width:500px;box-shadow:0 0 8px rgba(0,0,0,0.1);text-align:left;display:none}
</style>
</head>

<body>
  <h1>ü©∫ Talk to Asha</h1>
  <p>Hi! I‚Äôm Asha, your friendly health assistant. Click below to start talking!</p>

  <button id="startBtn">üé§ Talk to Asha</button>
  <button id="endBtn" class="secondary" style="display:none;">‚èπ End Call</button>
  <button id="openWidget" class="secondary">üí¨ Open Official Widget</button>

  <div id="micAnimation"></div>
  <div id="statusText">Waiting to connect...</div>

  <div id="transcriptBox">
    <h3>Conversation Transcript:</h3>
    <div id="transcriptText"></div>
  </div>

  <script>window.ELEVENLABS_WIDGET_DISABLE_AUTO_INIT = true;</script>
  <script src="https://elevenlabs.io/convai-widget/index.js"></script>

  <script>
  const AGENT_ID = "agent_1901k8v4exkseqk9s4ts0a5ycks2";
  let conversationWidget, transcript = "";

  async function startAsha() {
    const s = document.getElementById("statusText");
    const mic = document.getElementById("micAnimation");
    const box = document.getElementById("transcriptBox");
    const text = document.getElementById("transcriptText");
    const endBtn = document.getElementById("endBtn");

    if(!window.elevenlabs || !window.elevenlabs.Conversation){
      s.textContent="‚ùå ElevenLabs SDK failed to load.";
      return;
    }

    s.textContent="Connecting to Asha‚Ä¶";
    conversationWidget = window.elevenlabs.Conversation({
      agentId:AGENT_ID,
      onConnect:()=>{
        s.textContent="üé§ Listening‚Ä¶ Speak now!";
        mic.classList.add("listening");
        box.style.display="block";
        endBtn.style.display="inline-block";
      },
      onMessage:(msg)=>{
        const who = msg.source==="user"?"You":"Asha";
        const t = msg.message||msg.text||"";
        transcript += t+" ";
        text.innerHTML += `<p><strong>${who}:</strong> ${t}</p>`;
      },
      onDisconnect:()=>{
        mic.classList.remove("listening");
        s.textContent="Call ended.";
        handleExtractAndRedirect(transcript);
      }
    });

    try{await conversationWidget.startSession();}
    catch(e){console.error(e);s.textContent="‚ùå Could not connect.";}
  }

  // manual end call
  function endCall() {
    if(conversationWidget && conversationWidget.stopSession) {
      conversationWidget.stopSession();
    }
    handleExtractAndRedirect(transcript);
  }

  // keyword-based extraction
  function handleExtractAndRedirect(t){
    if(!t || t.length<10) {
      alert("Conversation too short to extract details!");
      return;
    }

    const data = {};
    const lower = t.toLowerCase();

    if(lower.includes("heart")||lower.includes("chest")) data.specialist="Cardiologist";
    else if(lower.includes("skin")) data.specialist="Dermatologist";
    else if(lower.includes("stomach")||lower.includes("acid")) data.specialist="Gastroenterologist";
    else data.specialist="General Physician";

    const dateMatch = t.match(/(\d{1,2}\s*(?:jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)|tomorrow)/i);
    if(dateMatch) data.date=dateMatch[1];

    const timeMatch = t.match(/(\d{1,2}\s*(?:am|pm))/i);
    if(timeMatch) data.time=timeMatch[1];

    const areaMatch = t.match(/(indiranagar|koramangala|whitefield|jayanagar)/i);
    if(areaMatch) data.area=areaMatch[1];

    const nameMatch = t.match(/(?:my name is|i am)\s+([A-Z][a-z]+\s*[A-Z]*[a-z]*)/i);
    if(nameMatch) data.name=nameMatch[1];

    const phoneMatch = t.match(/(\d{10})/);
    if(phoneMatch) data.phone=phoneMatch[1];

    const params = new URLSearchParams(data).toString();
    window.location.href = "doctors.html?" + params;
  }

  document.getElementById("startBtn").addEventListener("click", startAsha);
  document.getElementById("endBtn").addEventListener("click", endCall);

  document.getElementById("openWidget").addEventListener("click", ()=>{
    const html = `
      <!doctype html><meta charset="utf-8">
      <title>Asha Widget</title>
      <elevenlabs-convai agent-id="${AGENT_ID}"></elevenlabs-convai>
      <script src="https://elevenlabs.io/convai-widget/index.js"><\/script>`;
    const w = window.open();
    w.document.write(html);
    w.document.close();
  });
  </script>
</body>
</html>
