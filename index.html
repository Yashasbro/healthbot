<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asha ‚Äî Voice Health Assistant (Final Fixed)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:'Poppins',sans-serif;background:#f4f7fb;margin:0;padding:2rem;color:#122}
  h1{color:#0b5cff;margin-bottom:0.5rem}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin:1rem 0}
  button{background:#0b5cff;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600}
  button.alt{background:#eef6ff;color:#0b5cff;border:1px solid #d8e9ff}
  button.green{background:#19a974}
  #status{margin-top:8px;font-weight:600}
  #transcript{margin-top:12px;background:#fff;border-radius:10px;padding:14px;min-height:120px;color:#0d1b2a;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
</style>
</head>
<body>
  <h1>ü©∫ Asha ‚Äî Your Caring Health Assistant</h1>
  <p>Speak naturally. Asha will guide you softly and show doctors or help book if you wish.</p>

  <div class="btns">
    <button id="startBtn">üé§ Talk to Asha</button>
    <button id="pauseBtn" class="alt">‚è∏ Pause / Repeat</button>
    <button id="stopBtn" class="alt">‚èπ Stop</button>
    <button id="bandhuBtn" class="green">ü§ù Bandhu (Care Helpers)</button>
  </div>

  <div id="status">Status: idle</div>
  <div id="transcript"><em>Transcript will appear here‚Ä¶</em></div>

<script>
/*---------------------------------------------
  SETTINGS & DATA
---------------------------------------------*/
const SPECIALTIES = {
  "Cardiologist":["heart","chest","palpitation","bp","blood pressure","chest pain"],
  "Gastroenterologist":["stomach","acid","heartburn","nausea","indigestion","vomit","gastric"],
  "Dermatologist":["skin","rash","itch","acne","eczema","pimple"],
  "Neurologist":["headache","migraine","numb","seizure","dizzy"],
  "ENT":["ear","nose","throat","sinus","hearing"],
  "General Physician":["fever","cold","cough","body ache","weak"]
};
const PACKAGES = {
  "Cardiologist":["Heart Basic","Cardio Advanced","Cardio Executive"],
  "Gastroenterologist":["Digestive Basic","Gut Plus","GI Advanced"],
  "Dermatologist":["Skin Basic","Allergy Panel","Derm Advanced"],
  "Neurologist":["Neuro Basic","Neurology Panel","Migraine Check"],
  "ENT":["ENT Basic","Sinus Panel","Hearing Check"],
  "General Physician":["Full Body Basic","Complete Health","Preventive Pack"]
};
const ACCOUNT = { name:"LoggedIn User", phone:"9999999999" };
const AREAS = ["indiranagar","koramangala","whitefield","jayanagar","hsr","btm","malleshwaram"];

/*---------------------------------------------
  SPEECH UTILITIES
---------------------------------------------*/
let recognition, lastQuestion = "", resumeStep = null;

function append(t){ 
  const el=document.getElementById("transcript");
  if(el.innerHTML.includes("<em>")) el.innerHTML="";
  el.innerHTML += `<div>${t}</div>`;
  el.scrollTop = el.scrollHeight;
}

function saidYes(t){return /\b(yes|yeah|yep|sure|please|ok|okay)\b/i.test(t);}
function saidNo(t){return /\b(no|nah|nope|not really)\b/i.test(t);}

function detectSpecialist(t){
  t=t.toLowerCase();let top="General Physician",best=0;
  for(const s in SPECIALTIES){
    let c=0;for(const kw of SPECIALTIES[s]) if(t.includes(kw)) c++;
    if(c>best){best=c;top=s;}
  }return top;
}

async function voicesReady(){return new Promise(r=>{if(speechSynthesis.getVoices().length)r();else speechSynthesis.onvoiceschanged=r;});}
async function speak(txt){
  await voicesReady();
  lastQuestion = txt;
  return new Promise(res=>{
    const u=new SpeechSynthesisUtterance(txt);
    u.lang="en-IN";u.rate=0.95;u.pitch=1.1;
    const v=speechSynthesis.getVoices().find(x=>/female/i.test(x.name)&&/en-IN|en-GB/.test(x.lang));
    if(v)u.voice=v;
    u.onend=()=>res();
    speechSynthesis.cancel();speechSynthesis.speak(u);
  });
}

function listenOnce(timeout=10000){
  return new Promise(res=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){res("");return;}
    recognition = new SR();
    recognition.lang="en-IN";
    recognition.interimResults=true;
    let buffer="";
    recognition.onresult = e=>{
      for(let i=e.resultIndex;i<e.results.length;i++){
        buffer += " "+e.results[i][0].transcript;
      }
    };
    recognition.onend = ()=>res(buffer.trim());
    recognition.onerror = ()=>res(buffer.trim());
    recognition.start();
    setTimeout(()=>{try{recognition.stop();}catch{};res(buffer.trim());},timeout);
  });
}

function extractArea(text){
  text=text.toLowerCase();
  for(const a of AREAS) if(text.includes(a)) return a;
  const match=text.match(/in\s+([a-z]+)/i);
  return match?match[1]:"";
}

/*---------------------------------------------
  MAIN FLOW
---------------------------------------------*/
async function runFlow(){
  document.getElementById("transcript").innerHTML="";
  const s=document.getElementById("status");
  const state={};
  await step1();

  // STEP 1: Symptoms
  async function step1(){
    resumeStep = step1;
    lastQuestion = "How are you feeling? Please tell me your symptoms.";
    await speak("Hi, I‚Äôm Asha. "+lastQuestion);
    const sym=await listenOnce();
    append("You: "+sym);
    state.symptoms=sym;
    state.specialist=detectSpecialist(sym);
    await speak(`It sounds like you may need a ${state.specialist}.`);
    await step2();
  }

  // STEP 2: Booking yes/no
  async function step2(){
    resumeStep = step2;
    lastQuestion = "Would you like me to help book an appointment?";
    await speak(lastQuestion);
    const ans = await listenOnce();
    append("You: "+ans);
    if(saidYes(ans)){
      state.wantBooking=true;
      await speak("Okay, your account information will be considered for booking.");
      await step3();
    }else if(saidNo(ans)){
      state.wantBooking=false;
      await speak("Alright, I‚Äôll just show you the best doctors based on your symptoms.");
      redirect(state);
    }else{
      await speak("Sorry, I didn‚Äôt catch that. Please say yes or no.");
      await step2();
    }
  }

  // STEP 3: Mode
  async function step3(){
    resumeStep = step3;
    lastQuestion = "Do you prefer a physical appointment or a video consultation?";
    await speak(lastQuestion);
    const ans = await listenOnce();
    append("You: "+ans);
    state.mode=/video|online|virtual/i.test(ans)?"video":"physical";
    await speak(`${state.mode==="video"?"Video consultation":"Physical appointment"} noted.`);
    await step4();
  }

  // STEP 4: When & where
  async function step4(){
    resumeStep = step4;
    if(state.mode==="physical"){
      lastQuestion="When and where would you like the appointment? For example, tomorrow morning in Koramangala.";
      await speak(lastQuestion);
      const ans=await listenOnce();
      append("You: "+ans);
      state.datetime=ans;
      state.area=extractArea(ans);
    }else{
      lastQuestion="When would you like the video consultation?";
      await speak(lastQuestion);
      const ans=await listenOnce();
      append("You: "+ans);
      state.datetime=ans;
    }
    await step5();
  }

  // STEP 5: Health package
  async function step5(){
    resumeStep = step5;
    lastQuestion="Would you like to include a health package?";
    await speak(lastQuestion);
    const ans=await listenOnce();
    append("You: "+ans);
    if(saidYes(ans)){
      state.packages=PACKAGES[state.specialist]||PACKAGES["General Physician"];
      await speak(`Great, I‚Äôll suggest ${state.packages.slice(0,2).join(" and ")}.`);
    }else if(saidNo(ans)){
      state.packages=[];
      await speak("No problem, we‚Äôll skip packages.");
    }else{
      await speak("Sorry, please say yes or no.");
      await step5();
      return;
    }
    await speak("Showing you the doctors now.");
    redirect(state);
  }
}

/*---------------------------------------------
  REDIRECT + BUTTONS
---------------------------------------------*/
function redirect(state){
  const params=new URLSearchParams({
    symptoms:state.symptoms||"",
    specialist:state.specialist||"",
    wantBooking:state.wantBooking?"true":"false",
    mode:state.mode||"",
    datetime:state.datetime||"",
    area:state.area||"",
    packages:(state.packages||[]).join(","),
    accountName:"LoggedIn User",
    accountPhone:"9999999999"
  });
  setTimeout(()=>window.location.href="doctors.html?"+params.toString(),700);
}

document.getElementById("startBtn").onclick=()=>{speechSynthesis.cancel();runFlow();};
document.getElementById("stopBtn").onclick=()=>{speechSynthesis.cancel();try{recognition.stop();}catch{};document.getElementById("status").textContent="Stopped.";};
document.getElementById("pauseBtn").onclick=()=>{speechSynthesis.cancel();if(typeof resumeStep==="function"){speak("Let me repeat that.");resumeStep();}};
document.getElementById("bandhuBtn").onclick=()=>location.href="bandhu.html";
</script>
</body>
</html>
