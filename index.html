<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asha ‚Äî Voice Health Assistant (Enhanced)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:'Poppins',sans-serif;background:#f4f7fb;margin:0;padding:2rem;color:#122}
  h1{color:#0b5cff;margin-bottom:0.5rem}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin:1rem 0}
  button{background:#0b5cff;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600}
  button.alt{background:#eef6ff;color:#0b5cff;border:1px solid #d8e9ff}
  button.green{background:#19a974}
  #status{margin-top:8px;font-weight:600}
  #transcript{margin-top:12px;background:#fff;border-radius:10px;padding:14px;min-height:120px;color:#0d1b2a;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
</style>
</head>
<body>
  <h1>ü©∫ Asha ‚Äî Your Caring Health Assistant</h1>
  <p>Speak naturally. Asha will guide you softly and show doctors or help book if you wish.</p>

  <div class="btns">
    <button id="startBtn">üé§ Talk to Asha</button>
    <button id="pauseBtn" class="alt">‚è∏ Pause / Repeat</button>
    <button id="stopBtn" class="alt">‚èπ Stop</button>
    <button id="bandhuBtn" class="green">ü§ù Bandhu (Care Helpers)</button>
  </div>

  <div id="status">Status: idle</div>
  <div id="transcript"><em>Transcript will appear here‚Ä¶</em></div>

<script>
/*---------------------------------------------
  SETTINGS & DATA
---------------------------------------------*/
const SPECIALTIES = {
  "Cardiologist":["heart","chest","palpitation","bp","blood pressure","chest pain"],
  "Gastroenterologist":["stomach","acid","heartburn","nausea","indigestion","vomit","gastric"],
  "Dermatologist":["skin","rash","itch","acne","eczema","pimple"],
  "Neurologist":["headache","migraine","numb","seizure","dizzy"],
  "ENT":["ear","nose","throat","sinus","hearing"],
  "General Physician":["fever","cold","cough","body ache","weak"]
};
const PACKAGES = {
  "Cardiologist":["Heart Basic","Cardio Advanced","Cardio Executive"],
  "Gastroenterologist":["Digestive Basic","Gut Plus","GI Advanced"],
  "Dermatologist":["Skin Basic","Allergy Panel","Derm Advanced"],
  "Neurologist":["Neuro Basic","Neurology Panel","Migraine Check"],
  "ENT":["ENT Basic","Sinus Panel","Hearing Check"],
  "General Physician":["Full Body Basic","Complete Health","Preventive Pack"]
};
const ACCOUNT = { name:"LoggedIn User", phone:"9999999999" };
const AREAS = ["indiranagar","koramangala","whitefield","jayanagar","hsr","btm","malleshwaram"];

/*---------------------------------------------
  SPEECH UTILITIES
---------------------------------------------*/
let lastQuestion = "";
let recognition, recognizing = false;
function append(t){ 
  const el=document.getElementById("transcript");
  if(el.innerHTML.includes("<em>")) el.innerHTML="";
  el.innerHTML += `<div>${t}</div>`;
  el.scrollTop = el.scrollHeight;
}
function containsYes(t){return /\b(yes|yeah|yep|sure|ok|okay|please)\b/i.test(t);}
function detectSpecialist(t){
  t=t.toLowerCase();let top="General Physician",best=0;
  for(const s in SPECIALTIES){
    let c=0;for(const kw of SPECIALTIES[s]) if(t.includes(kw)) c++;
    if(c>best){best=c;top=s;}
  }return top;
}
async function voicesReady(){return new Promise(r=>{if(speechSynthesis.getVoices().length)r();else speechSynthesis.onvoiceschanged=r;});}
async function speak(txt){
  await voicesReady();
  lastQuestion = txt;
  return new Promise(res=>{
    const u=new SpeechSynthesisUtterance(txt);
    u.lang="en-IN";u.rate=0.95;u.pitch=1.1;
    const v=speechSynthesis.getVoices().find(x=>/female/i.test(x.name)&&/en-IN|en-GB/.test(x.lang));
    if(v)u.voice=v;
    u.onend=()=>res();
    speechSynthesis.cancel();speechSynthesis.speak(u);
  });
}
function listenOnce(timeout=10000){
  return new Promise(res=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){res("");return;}
    recognition = new SR();
    recognition.lang="en-IN";
    recognition.interimResults=true;
    recognition.continuous=false;
    let final="";
    recognition.onresult=e=>{
      for(let i=e.resultIndex;i<e.results.length;++i){
        const tr=e.results[i][0].transcript;
        if(e.results[i].isFinal) final=tr;
      }
    };
    recognition.onend=()=>res(final.trim());
    recognition.onerror=()=>res(final.trim());
    recognition.start();
    setTimeout(()=>{try{recognition.stop();}catch{};res(final.trim());},timeout);
  });
}
function extractArea(text){
  text=text.toLowerCase();
  for(const a of AREAS) if(text.includes(a)) return a;
  const match=text.match(/in\s+([a-z]+)/i);
  return match?match[1]:"";
}

/*---------------------------------------------
  MAIN FLOW
---------------------------------------------*/
async function runFlow(){
  document.getElementById("transcript").innerHTML="";
  const s=document.getElementById("status");
  s.textContent="Listening‚Ä¶";
  const state={symptoms:"",specialist:"",wantBooking:false,mode:"",datetime:"",area:"",packages:[],accountName:ACCOUNT.name,accountPhone:ACCOUNT.phone};

  // 1Ô∏è‚É£ Symptoms
  await speak("Hi, I‚Äôm Asha. How are you feeling? Please tell me your symptoms.");
  const sym=await listenOnce();state.symptoms=sym;append("You: "+sym);
  state.specialist=detectSpecialist(sym);await speak(`Hmm, sounds like you may need a ${state.specialist}.`);

  // 2Ô∏è‚É£ Want booking?
  await speak("Would you like me to help book an appointment?");
  const want=await listenOnce();append("You: "+want);
  state.wantBooking=containsYes(want);

  if(!state.wantBooking){
    await speak("Alright, I‚Äôll just show you the best doctors based on your symptoms.");
    redirect(state);
    return;
  }
  await speak("Okay, your account information will be considered for booking.");

  // 3Ô∏è‚É£ Appointment mode
  await speak("Do you prefer a physical appointment or a video consultation?");
  const modeAns=await listenOnce();append("You: "+modeAns);
  state.mode=/video|online|virtual/i.test(modeAns)?"video":"physical";
  await speak(`${state.mode==="video"?"Video consultation":"Physical appointment"} ‚Äî got it.`);

  // 4Ô∏è‚É£ Time and area
  if(state.mode==="physical"){
    await speak("When and where would you like the appointment? For example, tomorrow morning in Koramangala.");
    const dt=await listenOnce();append("You: "+dt);
    state.datetime=dt;
    state.area=extractArea(dt);
  }else{
    await speak("When would you like the video consultation?");
    const dt=await listenOnce();append("You: "+dt);
    state.datetime=dt;
  }

  // 5Ô∏è‚É£ Health package
  await speak("Would you like to include a health package?");
  const pkgAns=await listenOnce();append("You: "+pkgAns);
  if(containsYes(pkgAns)){
    state.packages=PACKAGES[state.specialist]||PACKAGES["General Physician"];
    await speak(`Great, I‚Äôll suggest options like ${state.packages.slice(0,2).join(" and ")}.`);
  }else{
    await speak("No problem, we‚Äôll skip packages.");
  }

  // ‚úÖ Done ‚Äî redirect to doctors
  await speak("Showing you the doctors now.");
  redirect(state);
}

function redirect(state){
  const params=new URLSearchParams({
    symptoms:state.symptoms,
    specialist:state.specialist,
    wantBooking:state.wantBooking,
    mode:state.mode,
    datetime:state.datetime,
    area:state.area,
    packages:(state.packages||[]).join(","),
    accountName:state.accountName,
    accountPhone:state.accountPhone
  });
  setTimeout(()=>window.location.href="doctors.html?"+params.toString(),700);
}

/*---------------------------------------------
  BUTTONS
---------------------------------------------*/
document.getElementById("startBtn").onclick=()=>{speechSynthesis.cancel();runFlow();};
document.getElementById("stopBtn").onclick=()=>{speechSynthesis.cancel();try{recognition.stop();}catch{};document.getElementById("status").textContent="Stopped.";};
document.getElementById("pauseBtn").onclick=()=>{speechSynthesis.cancel();if(lastQuestion)speak("Let me repeat that. "+lastQuestion);};
document.getElementById("bandhuBtn").onclick=()=>location.href="bandhu.html";
</script>
</body>
</html>
