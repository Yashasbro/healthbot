<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asha ‚Äî Voice Health Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:'Poppins',sans-serif;background:#f4f7fb;margin:0;padding:28px;color:#122}
  .wrap{max-width:900px;margin:0 auto;padding:18px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(16,24,40,.06)}
  h1{color:#0b5cff;margin:0 0 12px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  button{background:#0b5cff;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:600}
  button.alt{background:#eef6ff;color:#0b5cff;border:1px solid #d8e9ff}
  button.green{background:#19a974}
  #status{margin-top:8px;font-weight:600}
  #transcript{margin-top:12px;background:#f6f9ff;border-radius:10px;padding:14px;min-height:140px;color:#0d1b2a;line-height:1.4}
  .small{font-size:13px;color:#6b7280;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ü©∫ Asha ‚Äî Your Caring Health Assistant</h1>
  <p class="small">Speak naturally. Asha asks a few questions, suggests doctors and packages, and can auto-fill the booking form.</p>

  <div class="controls">
    <button id="startBtn">üé§ Start</button>
    <button id="pauseBtn" class="alt">‚è∏ Pause / Repeat</button>
    <button id="stopBtn" class="alt">‚èπ Stop</button>
  </div>

  <div id="status">Status: Idle</div>
  <div id="transcript"><em>Transcript will appear here...</em></div>
</div>

<script>
/* ---------- Configuration ---------- */
const SPECIALTIES = {
  "Cardiologist":["heart","chest","palpitation","bp","blood pressure","chest pain"],
  "Gastroenterologist":["stomach","acid","heartburn","nausea","indigestion","vomit","gastric"],
  "Dermatologist":["skin","rash","itch","acne","eczema","pimple"],
  "Neurologist":["headache","migraine","numb","seizure","dizzy"],
  "ENT":["ear","nose","throat","sinus","hearing"],
  "General Physician":["fever","cold","cough","body ache","weak"]
};
const PACKAGES = {
  "Cardiologist":["Heart Basic","Cardio Advanced","Cardio Executive"],
  "Gastroenterologist":["Digestive Basic","Gut Plus","GI Advanced"],
  "Dermatologist":["Skin Basic","Allergy Panel","Derm Advanced"],
  "Neurologist":["Neuro Basic","Neurology Panel","Migraine Check"],
  "ENT":["ENT Basic","Sinus Panel","Hearing Check"],
  "General Physician":["Full Body Basic","Complete Health","Preventive Pack"]
};
const ACCOUNT = { name: "LoggedIn User", phone: "9999999999" };
const AREAS = ["indiranagar","koramangala","whitefield","jayanagar","hsr","btm","malleshwaram","banashankari","rajajinagar"];

/* ---------- UI refs ---------- */
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const statusEl = document.getElementById('status');
const transcriptEl = document.getElementById('transcript');

let recognition = null;
let lastQuestion = "";
let resumeStep = null;

/* ---------- Speech helpers ---------- */
async function voicesReady(){
  return new Promise(r=>{const v=speechSynthesis.getVoices(); if(v.length) r(); else speechSynthesis.onvoiceschanged = r;});
}
async function speak(text){
  await voicesReady();
  lastQuestion = text;
  return new Promise(resolve=> {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-IN';
    u.rate = 0.95;
    u.pitch = 1.1;
    const v = speechSynthesis.getVoices().find(x=>/female/i.test(x.name)&&/en-IN|en-GB/.test(x.lang));
    if(v) u.voice = v;
    u.onend = ()=> { statusEl.textContent = "Asha: " + text; resolve(); };
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  });
}
function appendTranscript(text){
  if(transcriptEl.innerHTML.includes("<em>")) transcriptEl.innerHTML = "";
  transcriptEl.innerHTML += `<div style="margin:8px 0">${text}</div>`;
  transcriptEl.scrollTop = transcriptEl.scrollHeight;
}

/* ---------- listenOnce (only final results) ---------- */
function listenOnce(timeout = 10000){
  return new Promise(res=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ res(""); return; }
    try{
      recognition = new SR();
      recognition.lang = 'en-IN';
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      let finalText = "";
      let returned = false;
      recognition.onresult = (ev) => {
        for(let i = ev.resultIndex; i < ev.results.length; ++i){
          if(ev.results[i].isFinal) finalText += " " + ev.results[i][0].transcript;
        }
      };
      recognition.onerror = ()=>{ if(!returned){ returned = true; try{ recognition.stop(); }catch{} res(finalText.trim()); } };
      recognition.onend = ()=>{ if(!returned){ returned = true; res(finalText.trim()); } };
      recognition.start();
      setTimeout(()=>{ if(!returned){ returned = true; try{ recognition.stop(); }catch{} res(finalText.trim()); } }, timeout);
    } catch(e){
      console.warn("listenOnce error", e);
      res("");
    }
  });
}

/* ---------- small utilities ---------- */
function interpretYesNo(text){
  text = (text||"").toLowerCase();
  const yes = ["yes","yeah","yep","sure","ok","okay","please","yup"];
  const no  = ["no","nah","nope","not really","dont","don't"];
  let y=0,n=0;
  for(const w of yes) if(text.includes(w)) y++;
  for(const w of no) if(text.includes(w)) n++;
  if(y>n) return "yes";
  if(n>y) return "no";
  return "unknown";
}
function detectSpecialist(text){
  const t = (text||"").toLowerCase();
  let best = "General Physician",score=0;
  for(const s in SPECIALTIES){
    let c=0; for(const k of SPECIALTIES[s]) if(t.includes(k)) c++;
    if(c>score){score=c;best=s;}
  }
  return best;
}
function extractArea(text){
  if(!text) return "";
  text = text.toLowerCase();
  for(const a of AREAS) if(text.includes(a)) return a;
  const m = text.match(/in\s+([a-z ]{3,30})/i);
  if(m && m[1]) return m[1].trim().split(/\s+/)[0];
  return "";
}

/* ---------- Main voice flow (4 questions + extras) ---------- */
async function runFlow(){
  transcriptEl.innerHTML = "";
  statusEl.textContent = "Running...";
  const state = { symptoms:"", specialist:"", durationDays:"", otherInfo:"", wantBooking:false, mode:"", datetime:"", area:"", packages:[], accountName:ACCOUNT.name, accountPhone:ACCOUNT.phone };

  // Step 1: symptoms
  resumeStep = stepSymptoms; await stepSymptoms();
  async function stepSymptoms(){
    lastQuestion = "Please tell me your symptoms in a few words.";
    await speak("Hi, I'm Asha. " + lastQuestion);
    const ans = await listenOnce(12000);
    if(ans && ans.trim()) appendTranscript("You: " + ans.trim()); else appendTranscript("You: [no response]");
    state.symptoms = ans || "";
    state.specialist = detectSpecialist(ans);
    await speak(`I understand. This sounds like ${state.specialist}.`);
    resumeStep = stepDuration; await stepDuration();
  }

  // Step 1b: duration
  async function stepDuration(){
    lastQuestion = "How many days have you had these symptoms?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    if(ans && ans.trim()) appendTranscript("You: " + ans.trim()); else appendTranscript("You: [no response]");
    const d = (ans||"").match(/(\d+)/);
    state.durationDays = d?d[1]:(ans||"");
    resumeStep = stepOther; await stepOther();
  }

  // Step 1c: other conditions
  async function stepOther(){
    lastQuestion = "Do you have any other medical conditions, ongoing medicines, or allergies?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    if(ans && ans.trim()) appendTranscript("You: " + ans.trim()); else appendTranscript("You: [no response]");
    state.otherInfo = ans || "";
    resumeStep = stepBooking; await stepBooking();
  }

  // Step 2: booking yes/no
  async function stepBooking(){
    lastQuestion = "Would you like me to help book an appointment?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    if(ans && ans.trim()) appendTranscript("You: " + ans.trim()); else appendTranscript("You: [no response]");
    const yn = interpretYesNo(ans);
    if(yn === "yes"){ state.wantBooking = true; await speak("Okay ‚Äî your account information will be used for booking."); resumeStep = stepMode; await stepMode(); }
    else if(yn === "no"){ state.wantBooking = false; await speak("Alright ‚Äî I will show recommended doctors for your symptoms."); redirect(state); return; }
    else{ await speak("Please say yes or no."); await stepBooking(); return; }
  }

  // Step 3: mode
  async function stepMode(){
    lastQuestion = "Do you prefer a physical appointment or a video consultation?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    if(ans && ans.trim()) appendTranscript("You: " + ans.trim()); else appendTranscript("You: [no response]");
    state.mode = /video|online|virtual/i.test(ans) ? "video" : "physical";
    await speak(`${state.mode === "video" ? "Video consultation" : "Physical appointment"} selected.`);
    resumeStep = stepDateTime; await stepDateTime();
  }

  // Step 4: datetime & area
  async function stepDateTime(){
    if(state.mode === "physical") lastQuestion = "When and where would you like the appointment? For example, tomorrow morning in Koramangala.";
    else lastQuestion = "When would you like the video consultation? For example, tomorrow evening.";
    await speak(lastQuestion);
    const ans = await listenOnce(12000);
    if(ans && ans.trim()) appendTranscript("You: " + ans.trim()); else appendTranscript("You: [no response]");
    state.datetime = ans || "";
    if(state.mode === "physical") state.area = extractArea(ans);
    resumeStep = stepPackages; await stepPackages();
  }

  // Step 5: packages
  async function stepPackages(){
    lastQuestion = "Would you like me to include a health package for better care?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    if(ans && ans.trim()) appendTranscript("You: " + ans.trim()); else appendTranscript("You: [no response]");
    const yn = interpretYesNo(ans);
    if(yn === "yes"){ state.packages = PACKAGES[state.specialist] || PACKAGES["General Physician"]; await speak(`I found ${state.packages.length} packages, like ${state.packages.slice(0,2).join(" and ")}.`); await speak("Showing doctors now."); redirect(state); }
    else if(yn === "no"){ state.packages = []; await speak("Okay ‚Äî no package added."); await speak("Showing doctors now."); redirect(state); }
    else{ await speak("Sorry, please say yes or no."); await stepPackages(); return; }
  }
}

/* ---------- redirect to doctors.html with params ---------- */
function redirect(state){
  const q = new URLSearchParams({
    symptoms: state.symptoms || "",
    specialist: state.specialist || "",
    durationDays: state.durationDays || "",
    otherInfo: state.otherInfo || "",
    wantBooking: state.wantBooking ? "true" : "false",
    mode: state.mode || "",
    datetime: state.datetime || "",
    area: state.area || "",
    packages: (state.packages || []).join(","),
    name: state.accountName || ACCOUNT.name,
    phone: state.accountPhone || ACCOUNT.phone
  }).toString();
  setTimeout(()=> window.location.href = "doctors.html?" + q, 600);
}

/* ---------- Buttons ---------- */
startBtn.addEventListener('click', ()=> { try{ speechSynthesis.cancel(); }catch{} runFlow().catch(e=>console.error(e)); });
stopBtn.addEventListener('click', ()=> { try{ recognition && recognition.stop(); } catch(e){} try{ speechSynthesis.cancel(); }catch{} statusEl.textContent="Stopped."; });
pauseBtn.addEventListener('click', async ()=> { try{ speechSynthesis.cancel(); }catch{} if(lastQuestion){ await speak("Repeating: " + lastQuestion); if(typeof resumeStep === "function") resumeStep(); } });

/* ---------- autostart if opened with ?autostart=true ---------- */
window.addEventListener('load', ()=> {
  const params = new URLSearchParams(window.location.search);
  if(params.get('autostart') === 'true'){
    // small delay for UI to render then start
    setTimeout(()=> startBtn.click(), 300);
  }
});
</script>
</body>
</html>
