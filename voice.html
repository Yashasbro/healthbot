<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asha ‚Äî Voice Health Assistant (Stable)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:'Poppins',sans-serif;background:#f4f7fb;margin:0;padding:24px;color:#122}
  .card{max-width:920px;margin:24px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 12px 30px rgba(16,24,40,0.06)}
  h1{color:#0b5cff;margin:0 0 8px}
  p.lead{color:#555;margin:0 0 14px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  button{background:#0b5cff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
  button.alt{background:#eef6ff;color:#0b5cff;border:1px solid #d8e9ff}
  button.green{background:#19a974}
  #status{margin-top:8px;font-weight:600}
  #transcript{margin-top:12px;background:#fbfdff;border-radius:10px;padding:14px;min-height:140px;color:#0d1b2a;box-shadow:0 4px 10px rgba(0,0,0,0.04)}
  .small{font-size:13px;color:#6b7280;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <h1>ü©∫ Asha ‚Äî Your Caring Health Assistant</h1>
    <p class="lead">Speak naturally. Asha will ask a few questions (now includes symptom duration & allergies), then show doctors. Use Pause/Repeat if you want Asha to repeat the last question.</p>

    <div class="controls">
      <button id="startBtn">üé§ Talk to Asha</button>
      <button id="pauseBtn" class="alt">‚è∏ Pause / Repeat</button>
      <button id="stopBtn" class="alt">‚èπ Stop</button>
      <button id="bandhuBtn" class="green">ü§ù Bandhu (Care Helpers)</button>
    </div>

    <div id="status">Status: idle</div>
    <div id="transcript"><em>Transcript will appear here‚Ä¶</em></div>
    <div class="small">Works best in Chrome. Allow microphone access when prompted.</div>
  </div>

<script>
/* -------------------------
   Configuration & Data
   ------------------------- */
// Auto-start if redirected from home.html
window.addEventListener("load", () => {
  const params = new URLSearchParams(window.location.search);
  if (params.get("autostart") === "true") {
    document.getElementById("startBtn").click();
  }
});

const SPECIALTIES = {
  "Cardiologist":["heart","chest","palpitation","bp","blood pressure","chest pain"],
  "Gastroenterologist":["stomach","acid","heartburn","nausea","indigestion","vomit","gastric"],
  "Dermatologist":["skin","rash","itch","acne","eczema","pimple"],
  "Neurologist":["headache","migraine","numb","seizure","dizzy"],
  "ENT":["ear","nose","throat","sinus","hearing"],
  "General Physician":["fever","cold","cough","body ache","weak"]
};
const PACKAGES = {
  "Cardiologist":["Heart Basic","Cardio Advanced","Cardio Executive"],
  "Gastroenterologist":["Digestive Basic","Gut Plus","GI Advanced"],
  "Dermatologist":["Skin Basic","Allergy Panel","Derm Advanced"],
  "Neurologist":["Neuro Basic","Neurology Panel","Migraine Check"],
  "ENT":["ENT Basic","Sinus Panel","Hearing Check"],
  "General Physician":["Full Body Basic","Complete Health","Preventive Pack"]
};
const ACCOUNT = { name: "LoggedIn User", phone: "9999999999" };
const AREAS = ["indiranagar","koramangala","whitefield","jayanagar","hsr","btm","malleshwaram","banashankari","rajajinagar"];

/* -------------------------
   UI refs & state
   ------------------------- */
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const bandhuBtn = document.getElementById('bandhuBtn');
const statusEl = document.getElementById('status');
const transcriptEl = document.getElementById('transcript');

let recognition = null;
let lastQuestion = "";
let resumeStep = null;
let flowActive = false;

/* -------------------------
   Speech helpers
   ------------------------- */
async function voicesReady(){
  return new Promise(res => {
    const v = speechSynthesis.getVoices();
    if(v.length) return res();
    speechSynthesis.onvoiceschanged = () => res();
    setTimeout(res, 800);
  });
}
async function speak(text){
  await voicesReady();
  lastQuestion = text;
  try{
    return await new Promise(resolve => {
      const utt = new SpeechSynthesisUtterance(text);
      utt.lang = 'en-IN';
      utt.rate = 0.95;
      utt.pitch = 1.12;
      // pick a female en-IN (if available)
      const voice = speechSynthesis.getVoices().find(v=>/female/i.test(v.name) && /en-IN|en-GB/.test(v.lang));
      if(voice) utt.voice = voice;
      utt.onend = () => { statusEl.textContent = "Asha: " + text; resolve(); };
      speechSynthesis.cancel();
      speechSynthesis.speak(utt);
    });
  }catch(err){
    console.warn("speak error", err);
  }
}
function appendTranscript(text){
  if(transcriptEl.innerHTML.includes("<em>")) transcriptEl.innerHTML = "";
  transcriptEl.innerHTML += `<div style="margin:8px 0">${text}</div>`;
  transcriptEl.scrollTop = transcriptEl.scrollHeight;
}

/* listenOnce collects interim + final, returns accumulated string */
function listenOnce(timeout = 10000){
  return new Promise(res => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { res(""); return; }
    try {
      recognition = new SR();
      recognition.lang = 'en-IN';
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      let buffer = "";
      let returned = false;

      recognition.onresult = (ev) => {
        // accumulate all transcripts (interim + final)
        let interim = "";
        for (let i = ev.resultIndex; i < ev.results.length; ++i) {
          interim += " " + ev.results[i][0].transcript;
        }
        buffer = buffer + " " + interim;
      };

      recognition.onerror = (e) => {
        if (!returned) { returned = true; try{ recognition.stop(); }catch{} res(buffer.trim()); }
      };

      recognition.onend = () => {
        if (!returned) { returned = true; res(buffer.trim()); }
      };

      recognition.start();

      // safety timeout
      setTimeout(() => {
        if (!returned) { returned = true; try{ recognition.stop(); }catch{} res(buffer.trim()); }
      }, timeout);
    } catch (err) {
      console.warn("listenOnce start failed", err);
      res("");
    }
  });
}

/* interpret yes/no: count occurrences across whole captured text */
function interpretYesNo(text){
  text = (text || "").toLowerCase();
  const yesWords = ["yes","yeah","yep","sure","ok","okay","please","yup"];
  const noWords  = ["no","nah","nope","not really","dont","don't"];
  let y=0,n=0;
  for(const w of yesWords) if(text.includes(w)) y++;
  for(const w of noWords) if(text.includes(w)) n++;
  if(y>n) return "yes";
  if(n>y) return "no";
  return "unknown";
}

/* detect specialist by keyword scoring */
function detectSpecialist(text){
  const t = (text||"").toLowerCase();
  let best="General Physician",score=0;
  for(const s in SPECIALTIES){
    let c=0;
    for(const kw of SPECIALTIES[s]) if(t.includes(kw)) c++;
    if(c>score){score=c;best=s;}
  }
  return best;
}

/* extract area heuristics */
function extractArea(text){
  if(!text) return "";
  text = text.toLowerCase();
  for(const a of AREAS) if(text.includes(a)) return a;
  const m = text.match(/in\s+([a-z ]{3,30})/i);
  if(m && m[1]) return m[1].trim().split(/\s+/)[0];
  return "";
}

/* -------------------------
   Flow steps (robust + resumable)
   ------------------------- */
async function runFlow(){
  flowActive = true;
  transcriptEl.innerHTML = "";
  statusEl.textContent = "Status: running";

  const state = {
    symptoms: "", specialist: "", durationDays: "", otherInfo: "",
    wantBooking: false, mode: "", datetime: "", area: "", packages: [],
    accountName: ACCOUNT.name, accountPhone: ACCOUNT.phone
  };

  // Step 1: Symptoms
  resumeStep = stepSymptoms;
  await stepSymptoms();

  async function stepSymptoms(){
    lastQuestion = "Please tell me your symptoms in a few words.";
    await speak("Hi, I'm Asha. " + lastQuestion);
    const ans = await listenOnce(12000);
    appendTranscript("You: " + (ans || "[no response]"));
    state.symptoms = ans || "";
    state.specialist = detectSpecialist(ans || "");
    await speak(`I understand. This sounds like ${state.specialist}.`);
    // Next: how many days
    resumeStep = stepDuration;
    await stepDuration();
  }

  // Step 1b: duration (new)
  async function stepDuration(){
    lastQuestion = "How many days have you had these symptoms?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    appendTranscript("You: " + (ans || "[no response]"));
    // try extract digits
    const dMatch = (ans || "").match(/(\d+)\s*(day|days|d)/i);
    if(dMatch) state.durationDays = dMatch[1];
    else {
      // try words to digits small map
      const w = (ans||"").toLowerCase();
      const map = {one:1,two:2,three:3,four:4,five:5,week:7};
      for(const k in map) if(w.includes(k)) { state.durationDays = map[k]; break; }
      if(!state.durationDays) state.durationDays = ans || "";
    }
    // Next: other conditions/allergies
    resumeStep = stepOther;
    await stepOther();
  }

  // Step 1c: other conditions / allergies (new)
  async function stepOther(){
    lastQuestion = "Do you have any other medical conditions, ongoing medicines, or allergies?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    appendTranscript("You: " + (ans || "[no response]"));
    state.otherInfo = ans || "";
    // now booking question
    resumeStep = stepBooking;
    await stepBooking();
  }

  // Step 2: booking yes/no
  async function stepBooking(){
    lastQuestion = "Would you like me to help book an appointment?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    appendTranscript("You: " + (ans || "[no response]"));
    const yn = interpretYesNo(ans);
    if(yn === "yes"){
      state.wantBooking = true;
      await speak("Okay ‚Äî your account information will be used for booking.");
      resumeStep = stepMode;
      await stepMode();
    } else if(yn === "no"){
      state.wantBooking = false;
      await speak("Alright ‚Äî I will show recommended doctors for your symptoms.");
      redirectToDoctors(state);
      return;
    } else {
      // unclear - ask again
      await speak("Sorry, please say yes or no.");
      await stepBooking();
      return;
    }
  }

  // Step 3: mode (physical or video)
  async function stepMode(){
    lastQuestion = "Do you prefer a physical appointment or a video consultation?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    appendTranscript("You: " + (ans || "[no response]"));
    if(/video|online|virtual/i.test(ans || "")) state.mode = "video";
    else state.mode = "physical";
    await speak(`${state.mode === "video" ? "Video consultation" : "Physical appointment"} selected.`);
    resumeStep = stepDateTime;
    await stepDateTime();
  }

  // Step 4: datetime & area (merged)
  async function stepDateTime(){
    if(state.mode === "physical"){
      lastQuestion = "When and where would you like the appointment? For example, tomorrow morning in Koramangala.";
      await speak(lastQuestion);
      const ans = await listenOnce(12000);
      appendTranscript("You: " + (ans || "[no response]"));
      state.datetime = ans || "";
      // area extraction
      state.area = extractArea(ans || "");
    } else {
      lastQuestion = "When would you like the video consultation? For example, tomorrow evening.";
      await speak(lastQuestion);
      const ans = await listenOnce(9000);
      appendTranscript("You: " + (ans || "[no response]"));
      state.datetime = ans || "";
      state.area = "";
    }
    // now packages
    resumeStep = stepPackages;
    await stepPackages();
  }

  // Step 5: packages yes/no + selection
  async function stepPackages(){
    lastQuestion = "Would you like me to include a health package for better care?";
    await speak(lastQuestion);
    const ans = await listenOnce(9000);
    appendTranscript("You: " + (ans || "[no response]"));
    const yn = interpretYesNo(ans);
    if(yn === "yes"){
      state.packages = PACKAGES[state.specialist] || PACKAGES["General Physician"];
      // confirm to user
      await speak(`I found ${state.packages.length} packages, for example ${state.packages.slice(0,2).join(" and ")}. You can choose on the booking page.`);
      // final redirect to doctors (booking flow)
      await speak("Showing doctors now.");
      redirectToDoctors(state);
      return;
    } else if(yn === "no"){
      state.packages = [];
      await speak("Okay ‚Äî no package will be added.");
      await speak("Showing doctors now.");
      redirectToDoctors(state);
      return;
    } else {
      await speak("Sorry, say yes if you want packages, or no to skip.");
      await stepPackages();
      return;
    }
  }
} // end runFlow

/* -------------------------
   Redirect to doctors (encode params)
   ------------------------- */
function redirectToDoctors(state){
  const params = new URLSearchParams({
    symptoms: state.symptoms || "",
    specialist: state.specialist || "",
    durationDays: state.durationDays || "",
    otherInfo: state.otherInfo || "",
    wantBooking: state.wantBooking ? "true" : "false",
    mode: state.mode || "",
    datetime: state.datetime || "",
    area: state.area || "",
    packages: (state.packages || []).join(","),
    accountName: state.accountName || ACCOUNT.name,
    accountPhone: state.accountPhone || ACCOUNT.phone
  });
  setTimeout(()=> window.location.href = "doctors.html?" + params.toString(), 700);
}

/* -------------------------
   Buttons
   ------------------------- */
startBtn.addEventListener('click', () => {
  try{ speechSynthesis.cancel(); } catch(e){}
  runFlow().catch(e => { console.error(e); appendTranscript("Error: " + e.message); });
});
stopBtn.addEventListener('click', () => {
  try{ if(recognition) recognition.stop(); } catch(e){}
  try{ speechSynthesis.cancel(); } catch(e){}
  statusEl.textContent = "Stopped.";
});
pauseBtn.addEventListener('click', async () => {
  try{ speechSynthesis.cancel(); } catch(e){}
  // repeat last question and re-run the same step function (resumeStep)
  if(lastQuestion) {
    await speak("Repeating: " + lastQuestion);
    if(typeof resumeStep === "function"){
      // call the resume step to re-ask & listen
      resumeStep().catch(err => console.error(err));
    }
  } else {
    appendTranscript("No question to repeat yet.");
  }
});
bandhuBtn.addEventListener('click', () => window.location.href = "bandhu.html");

</script>
</body>
</html>


